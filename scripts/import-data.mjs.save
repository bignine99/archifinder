
'use strict';
/**
 * @fileOverview Script to import project metadata from a CSV file into Firestore.
 */
import fs from 'fs';
import path from 'path';
import { initializeApp, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';
import csv from 'csv-parser';

// --- Configuration ---
const SERVICE_ACCOUNT_PATH = path.join(process.cwd(), 'workspace', 'serviceAccountKey.json');
const CSV_FILE_PATH = path.join(process.cwd(), 'workspace', 'metadata.csv');
const FIRESTORE_COLLECTION = 'projects';
const BATCH_SIZE = 500; // Firestore batch writes are limited to 500 operations.

// --- Helper Functions ---

/**
 * Checks if the required files exist.
 * @returns {boolean} True if all files are found, otherwise false.
 */
function checkRequiredFiles() {
  if (!fs.existsSync(SERVICE_ACCOUNT_PATH)) {
    console.error(`âŒ Error: Service account key not found at ${SERVICE_ACCOUNT_PATH}`);
    console.error('Please download it from Firebase Console > Project Settings > Service accounts and save it as "serviceAccountKey.json" in your workspace directory.');
    return false;
  }
  if (!fs.existsSync(CSV_FILE_PATH)) {
    console.error(`âŒ Error: CSV file not found at ${CSV_FILE_PATH}`);
    console.error('Please ensure your "metadata.csv" file is in your workspace directory.');
    return false;
  }
  return true;
}

/**
 * Initializes Firebase Admin SDK.
 */
function initializeFirebase() {
  const serviceAccount = JSON.parse(fs.readFileSync(SERVICE_ACCOUNT_PATH, 'utf8'));
  initializeApp({
    credential: cert(serviceAccount),
  });
  console.log('ğŸ”¥ Firebase Admin SDK initialized.');
}

/**
 * Parses a string value from CSV into a number. Returns 0 if invalid.
 * @param {string} value The string value to parse.
 * @returns {number} The parsed number or 0.
 */
function parseNumber(value) {
  if (value === null || value === undefined || value.trim() === '') return 0;
  const num = Number(value);
  return isNaN(num) ? 0 : num;
}

/**
 * Transforms a CSV row into a Firestore document object.
 * @param {object} row A single row object from the CSV parser.
 * @returns {object} A Firestore document object.
 */
function transformRowToDoc(row) {
  // Map CSV column names (in Korean) to Firestore document fields (in English).
  return {
    id: row['ê³ ìœ ë²ˆí˜¸'],
    name: row['í”„ë¡œì íŠ¸'] || '',
    location: row['ì§€ì—­'] || '',
    address: row['ì£¼ì†Œ'] || '',
    projectType: row['ìš©ë„'] || 'ê¸°íƒ€',
    areaType: row['ì§€ì—­2'] || 'ê¸°íƒ€ì§€ì—­',
    siteArea: parseNumber(row['ëŒ€ì§€ë©´ì ']),
    buildingArea: parseNumber(row['ê±´ì¶•ë©´ì ']),
    totalFloorArea: parseNumber(row['ì—°ë©´ì ']),
    buildingCoverageRatio: parseNumber(row['ê±´íìœ¨']),
    floorAreaRatio: parseNumber(row['ìš©ì ë¥ ']),
    storiesAboveGround: parseNumber(row['ì§€ìƒì¸µìˆ˜']),
    storiesBelowGround: parseNumber(row['ì§€í•˜ì¸µìˆ˜']),
    structureType: row['êµ¬ì¡°'] || '',
    internalFinish: row['ë‚´ë¶€ë§ˆê°'] || '',
    externalFinish: row['ì™¸ë¶€ë§ˆê°'] || '',
    description: row['ì„¤ê³„ê°œë…'] || '',
    // --- Default values for fields not in CSV ---
    designConcepts: [], // To be populated by AI later
    files: [], // To be populated by another script or manually
    createdAt: new Date(),
  };
}


/**
 * Main function to run the import process.
 */
async function main() {
  console.log('ğŸš€ Starting Firestore data import...');
  if (!checkRequiredFiles()) {
    process.exit(1);
  }

  try {
    initializeFirebase();
    const db = getFirestore();
    const projects = [];

    // 1. Read and parse the CSV file
    await new Promise((resolve, reject) => {
      // íŒŒì„œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë³€ìˆ˜ì— ì €ì¥í•˜ì—¬ rawRowCountì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.
      const parser = csv({ headers: true }); // <<< { headers: true } ì˜µì…˜ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
      fs.createReadStream(CSV_FILE_PATH)
        .pipe(parser) // ë³€ìˆ˜ì— ì €ì¥ëœ íŒŒì„œ ì‚¬ìš©
        .on('data', (row) => {
          console.log('DEBUG: Parsed row:', row); // íŒŒì‹±ëœ í–‰ ê°ì²´ ë¡œê·¸
          console.log('DEBUG: Value of ê³ ìœ ë²ˆí˜¸:', row['ê³ ìœ ë²ˆí˜¸']); // <-- 'ê³ ìœ ë²ˆí˜¸' ê°’ ì§ì ‘ ì¶œë ¥
          
          // 'ê³ ìœ ë²ˆí˜¸' í‚¤ê°€ ê°ì²´ì— ì§ì ‘ ì¡´ì¬í•˜ëŠ”ì§€, ê·¸ë¦¬ê³  ê°’ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€ í™•ì¸
          if (row && Object.prototype.hasOwnProperty.call(row, 'ê³ ìœ ë²ˆí˜¸') && row['ê³ ìœ ë²ˆí˜¸'] && row['ê³ ìœ ë²ˆí˜¸'].trim() !== '') { 
            const projectDoc = transformRowToDoc(row);
            projects.push(projectDoc);
          } else {
            console.log('DEBUG: Skipping row (no valid or empty ê³ ìœ ë²ˆí˜¸):', row); // ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ê³ ìœ ë²ˆí˜¸ê°€ ë¹„ì–´ìˆëŠ” í–‰ ë¡œê·¸
          }
        })
        .on('end', () => {
          // parser.rawRowCount ëŒ€ì‹  projects ë°°ì—´ ê¸¸ì´ë¡œ ì´ í–‰ ìˆ˜ë¥¼ ì¶”ì •
          console.log(`DEBUG: Estimated total rows processed: ${projects.length + (parser.rawRowCount || 0)}`); // rawRowCountê°€ undefinedì¼ ê²½ìš° 0ìœ¼ë¡œ ì²˜ë¦¬
          console.log(`DEBUG: Projects array length after processing: ${projects.length}`);
          console.log(`âœ… CSV file successfully processed. Found ${projects.length} projects.`);
          resolve();
        })
        .on('error', reject);
    });

    if (projects.length === 0) {
      console.warn('âš ï¸ No projects found in CSV file. Exiting.');
      return;
    }

    // 2. Write data to Firestore in batches
    const collectionRef = db.collection(FIRESTORE_COLLECTION);
    let committedCount = 0;

    for (let i = 0; i < projects.length; i += BATCH_SIZE) {
      const batch = db.batch();
      const chunk = projects.slice(i, i + BATCH_SIZE);
nano scripts/import-data.mjs

      chunk.forEach((project) => {
        // Use the 'ê³ ìœ ë²ˆí˜¸' as the document ID for easy lookup
        const docRef = collectionRef.doc(project.id);
        batch.set(docRef, project);
      });

      await batch.commit();
      committedCount += chunk.length;
      console.log(`...Committed ${committedCount} of ${projects.length} projects to Firestore.`);
    }

    console.log('\nâœ… Import complete!');
    
  } catch (error) {
    console.error('\nâŒ An error occurred during the import process:');
    console.error(error);
    process.exit(1);
  }
}

main();
í”„ë¡œì íŠ¸ íƒìƒ‰ê¸°ì—ì„œ scripts í´ë” ì•ˆì— ìˆëŠ” import-data.mjs íŒŒì¼
